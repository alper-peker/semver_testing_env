name: AI PR Labeler

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai_label_suggestion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get PR Diff
        id: pr_data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          DIFF=$(gh pr diff $PR_NUMBER --repo $REPO | head -c 6000)

          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Read Labels JSON
        id: read_labels
        run: |
          if [ -f scripts/labels.json ]; then
            LABELS_CONTENT=$(cat scripts/labels.json | jq -c .)
          else
            echo "Error: scripts/labels.json file not found!"
            exit 1
          fi
          echo "LABELS=$LABELS_CONTENT" >> $GITHUB_ENV

      - name: Analyze with OpenAI
        id: openai_analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_LABEL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          PROMPT="You are a strict code classifier for a Monorepo. Analyze the PR and select appropriate labels.

          Repo Structure:
          - 'flask-api/' -> Backend logic
          - 'frontend-code/' -> Frontend UI
          - 'gcp-functions/' -> Serverless functions
          - 'nginx/' or 'docker-compose.yml' or 'infra/' -> Infrastructure

          Available Labels (JSON):
          $LABELS

          PR Title: $PR_TITLE
          PR Body: $PR_BODY

          PR Diff (Summary):
          $PR_DIFF

          Instructions:
          1. Analyze the file paths in the diff to understand WHICH component changed.
          2. Analyze the code logic to understand the NATURE of the change (feature, fix, refactor, breaking-change).
          3. Return a COMMA-SEPARATED list of label names.
          4. Output ONLY the labels, no explanation.
          5. If a file path matches a component but that component label is NOT in the JSON list, ignore the component label and only return SemVer labels.
          6. Priority: 'breaking-change' > 'feature' > 'fix'.

          Example Output:
          fix, refactor
          "
          PAYLOAD=$(jq -n \
            --arg model "gpt-4o-mini" \
            --arg system "You are a bot that classifies pull requests." \
            --arg user "$PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
              ],
              temperature: 0.1
            }')

          RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            echo "OpenAI API Error: $(echo $RESPONSE | jq -r '.error.message')"
            exit 1
          fi

          SUGGESTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          CLEAN_SUGGESTION=$(echo "$SUGGESTION" | sed 's/[."]//g' | tr -d '\n')

          echo "suggestion=$CLEAN_SUGGESTION" >> $GITHUB_OUTPUT

      - name: Apply Labels & Comment
        uses: actions/github-script@v6
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawLabels = process.env.SUGGESTION;
            if (!rawLabels) return;

            const labelsToAdd = rawLabels.split(',').map(l => l.trim()).filter(l => l.length > 0);

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labelsToAdd
              });

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ðŸ¤– **AI Label Analysis**\n\nApplied Labels: \`${labelsToAdd.join(', ')}\``
              });
            }
        env:
          SUGGESTION: ${{ steps.openai_analysis.outputs.suggestion }}
