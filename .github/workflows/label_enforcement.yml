name: Unified Label Process

on:
  pull_request:
    types:
      [
        opened,
        synchronize,
        reopened,
        edited,
        ready_for_review,
        labeled,
        unlabeled,
      ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to check"
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  APPROVAL_USERS: "AlperPeker, alper-peker"

jobs:
  ai_label_suggestion:
    name: AI Auto Labeller
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get PR Diff
        id: pr_data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          DIFF=$(gh pr diff $PR_NUMBER --repo $REPO | head -c 6000)
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Read Labels JSON
        id: read_labels
        run: |
          if [ -f scripts/labels.json ]; then
            LABELS_CONTENT=$(cat scripts/labels.json | jq -c .)
          else
            echo "Error: scripts/labels.json file not found!"
            exit 1
          fi
          echo "LABELS=$LABELS_CONTENT" >> $GITHUB_ENV

      - name: Analyze with OpenAI
        id: openai_analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_LABEL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          PROMPT="You are a GitHub PR Labeler Assistant.
          Here is the definition of available labels in JSON format:
          $LABELS
          
          Analyze the following Pull Request details and code diff to suggest the most appropriate labels.
          Strictly allow ONLY labels from the provided JSON list.
          Return ONLY a comma-separated list of labels (e.g. 'feature, backend'). Do not add any explanation or other text.
          
          PR Title: $PR_TITLE
          PR Body: $PR_BODY
          Diff Snippet:
          $PR_DIFF"

          PAYLOAD=$(jq -n \
            --arg model "gpt-4o-mini" \
            --arg system "You are a helpful assistant that suggests PR labels." \
            --arg user "$PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
              ],
              temperature: 0.3
            }')

          RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")

          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            exit 1
          fi

          SUGGESTION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          CLEAN_SUGGESTION=$(echo "$SUGGESTION" | sed 's/[."]//g' | tr -d '\n')
          echo "suggestion=$CLEAN_SUGGESTION" >> $GITHUB_OUTPUT

      - name: Apply Labels (Silent)
        uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const rawLabels = "${{ steps.openai_analysis.outputs.suggestion }}";
            if (!rawLabels) return;

            const labelsToAdd = rawLabels.split(',').map(l => l.trim()).filter(l => l.length > 0);

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labelsToAdd
              });
            }

  label-check:
    runs-on: ubuntu-latest
    needs: ai_label_suggestion
    if: always()
    steps:
      - name: Require approvals and SemVer labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const number =
              context.eventName === "pull_request"
                ? context.payload.pull_request.number
                : context.eventName === "workflow_dispatch"
                  ? Number(core.getInput('pr_number'))
                  : null;

            if (!number) {
              core.setFailed("PR number not found.");
              return;
            }

            async function getLabels() {
              const res = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number });
              return res.data.map(l => l.name);
            }

            const approvers = process.env.APPROVAL_USERS.split(',').map(s => s.trim());
            let labels = await getLabels();
            
            if (!labels.includes("approved")) {
              const comments = await github.rest.issues.listComments({
                 owner, repo, issue_number: number, per_page: 100
              });

              const pending = new Set(approvers);
              
              comments.data.forEach(c => {
                if ((c.body || "").trim().startsWith("/approve") && approvers.includes(c.user.login)) {
                  pending.delete(c.user.login);
                }
              });
              
              if (pending.size === 0) {
                 await github.rest.issues.addLabels({
                   owner, repo, issue_number: number, labels: ["approved"]
                 });
                 labels.push("approved");
              } else {
                 core.setFailed(`Missing approvals from: ${[...pending].join(', ')}`);
                 return; 
              }
            }

            const semver = new Set([
              "breaking-change", "feature", "fix", "security", "perf",
              "refactor", "docs", "test", "build", "ci", "deps", "revert"
            ]);
            
            const found = labels.filter(l => semver.has(l));

            if (found.length < 1) {
              core.setFailed("Missing SemVer label (feature, fix, breaking-change, etc.)");
              return;
            }
