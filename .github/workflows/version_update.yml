name: Component-aware SemVer Workflow

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: semver-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare_meta:
    name: Detect changed components & SemVer bump
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
    outputs:
      bump: ${{ steps.bump.outputs.bump }}
      changed_frontend: ${{ steps.changed.outputs.frontend }}
      changed_backend: ${{ steps.changed.outputs.backend }}
      changed_functions: ${{ steps.changed.outputs.functions }}
      changed_infra: ${{ steps.changed.outputs.infra }}
      global_tag: ${{ steps.tags.outputs.global_tag }}
      front_tag: ${{ steps.tags.outputs.front_tag }}
      back_tag: ${{ steps.tags.outputs.back_tag }}
      funcs_tag: ${{ steps.tags.outputs.funcs_tag }}
      infra_tag: ${{ steps.tags.outputs.infra_tag }}
      major: ${{ steps.bump.outputs.major }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed components
        id: changed
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          files="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"

          frontend=false
          backend=false
          functions=false
          infra=false

          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            if [[ "$f" == frontend-code/* ]]; then frontend=true; fi
            if [[ "$f" == flask-api/* ]]; then backend=true; fi
            if [[ "$f" == gcp-functions/* ]]; then functions=true; fi
            if [[ "$f" == infra/* || "$f" == docker-compose.yml || "$f" == Dockerfile* || "$f" == .github/* ]]; then infra=true; fi
          done <<< "$files"

          echo "frontend=$frontend" >> "$GITHUB_OUTPUT"
          echo "backend=$backend" >> "$GITHUB_OUTPUT"
          echo "functions=$functions" >> "$GITHUB_OUTPUT"
          echo "infra=$infra" >> "$GITHUB_OUTPUT"

      - name: Determine SemVer bump from labels
        id: bump
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);
            let bump = "patch";
            if (labels.includes("breaking-change")) bump = "major";
            else if (labels.includes("feature")) bump = "minor";
            core.setOutput("bump", bump);
            core.setOutput("major", bump === "major" ? "true" : "false");

      - name: Compute next tags
        id: tags
        run: |
          set -euo pipefail

          bump="${{ steps.bump.outputs.bump }}"

          get_latest() {
            local pattern="$1"
            local latest
            latest="$(git tag -l "$pattern" --sort=-v:refname | head -n 1 || true)"
            echo "$latest"
          }

          inc() {
            local v="$1"
            local bump="$2"
            v="${v#v}"
            IFS='.' read -r maj min pat <<< "$v"
            maj="${maj:-0}"
            min="${min:-0}"
            pat="${pat:-0}"
            if [[ "$bump" == "major" ]]; then
              maj=$((maj+1)); min=0; pat=0
            elif [[ "$bump" == "minor" ]]; then
              min=$((min+1)); pat=0
            else
              pat=$((pat+1))
            fi
            echo "v${maj}.${min}.${pat}"
          }

          latest_global="$(get_latest "v*.*.*")"
          [[ -z "$latest_global" ]] && latest_global="v0.0.0"
          next_global="$(inc "$latest_global" "$bump")"

          latest_front="$(get_latest "frontend-v*.*.*")"
          [[ -z "$latest_front" ]] && latest_front="frontend-v0.0.0"
          next_front="frontend-${next_global}"

          latest_back="$(get_latest "backend-v*.*.*")"
          [[ -z "$latest_back" ]] && latest_back="backend-v0.0.0"
          next_back="backend-${next_global}"

          latest_funcs="$(get_latest "functions-v*.*.*")"
          [[ -z "$latest_funcs" ]] && latest_funcs="functions-v0.0.0"
          next_funcs="functions-${next_global}"

          latest_infra="$(get_latest "infra-v*.*.*")"
          [[ -z "$latest_infra" ]] && latest_infra="infra-v0.0.0"
          next_infra="infra-${next_global}"

          echo "global_tag=$next_global" >> "$GITHUB_OUTPUT"
          echo "front_tag=$next_front" >> "$GITHUB_OUTPUT"
          echo "back_tag=$next_back" >> "$GITHUB_OUTPUT"
          echo "funcs_tag=$next_funcs" >> "$GITHUB_OUTPUT"
          echo "infra_tag=$next_infra" >> "$GITHUB_OUTPUT"

  create_tags:
    name: Create tags
    needs: prepare_meta
    runs-on: ubuntu-latest
    if: needs.prepare_meta.outputs.bump != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tags
        env:
          GLOBAL_TAG: ${{ needs.prepare_meta.outputs.global_tag }}
          FRONT_TAG: ${{ needs.prepare_meta.outputs.front_tag }}
          BACK_TAG: ${{ needs.prepare_meta.outputs.back_tag }}
          FUNCS_TAG: ${{ needs.prepare_meta.outputs.funcs_tag }}
          INFRA_TAG: ${{ needs.prepare_meta.outputs.infra_tag }}
          CHANGED_FRONTEND: ${{ needs.prepare_meta.outputs.changed_frontend }}
          CHANGED_BACKEND: ${{ needs.prepare_meta.outputs.changed_backend }}
          CHANGED_FUNCTIONS: ${{ needs.prepare_meta.outputs.changed_functions }}
          CHANGED_INFRA: ${{ needs.prepare_meta.outputs.changed_infra }}
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag -a "$GLOBAL_TAG" -m "$GLOBAL_TAG"

          if [[ "$CHANGED_FRONTEND" == "true" ]]; then
            git tag -a "$FRONT_TAG" -m "$FRONT_TAG"
          fi
          if [[ "$CHANGED_BACKEND" == "true" ]]; then
            git tag -a "$BACK_TAG" -m "$BACK_TAG"
          fi
          if [[ "$CHANGED_FUNCTIONS" == "true" ]]; then
            git tag -a "$FUNCS_TAG" -m "$FUNCS_TAG"
          fi
          if [[ "$CHANGED_INFRA" == "true" ]]; then
            git tag -a "$INFRA_TAG" -m "$INFRA_TAG"
          fi

          git push origin --tags

  major_release:
    name: Create releases (major only)
    needs: [prepare_meta, create_tags]
    runs-on: ubuntu-latest
    if: needs.prepare_meta.outputs.major == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub Releases (major)
        env:
          REPO: ${{ github.repository }}
          GLOBAL_TAG: ${{ needs.prepare_meta.outputs.global_tag }}
          FRONT_TAG: ${{ needs.prepare_meta.outputs.front_tag }}
          BACK_TAG: ${{ needs.prepare_meta.outputs.back_tag }}
          FUNCS_TAG: ${{ needs.prepare_meta.outputs.funcs_tag }}
          INFRA_TAG: ${{ needs.prepare_meta.outputs.infra_tag }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          create_release() {
            local tag="$1"
            local component="$2"

            if [[ -z "$tag" ]]; then
              return
            fi

            git fetch --tags --force

            local prev_tag=""
            local pattern
            if [[ "$component" == "global" ]]; then
              pattern="v*.*.*"
              prev_tag="$(git tag -l "$pattern" --sort=-v:refname | grep -v "^${tag}$" | head -n 1 || true)"
            else
              pattern="${component}-v*.*.*"
              prev_tag="$(git tag -l "$pattern" --sort=-v:refname | grep -v "^${tag}$" | head -n 1 || true)"
            fi

            local diff_output=""
            if [[ -n "$prev_tag" ]]; then
              diff_output=$(git diff "$prev_tag" "$tag" | head -c 3000 || true)
            else
              local path_filter=""
              case "$component" in
                "frontend") path_filter="frontend-code/" ;;
                "backend") path_filter="flask-api/" ;;
                "functions") path_filter="gcp-functions/" ;;
                "infra") path_filter="." ;;
                "global") path_filter="." ;;
              esac

              diff_output=$(git log --oneline -- "$path_filter" | head -n 50 || true)
              diff_output="$(printf "%s\n\n(Initial release; showing recent commits instead of full diff.)" "$diff_output")"
            fi

            local NOTES=""
            if [[ -z "${OPENAI_API_KEY:-}" ]]; then
              NOTES="Major release for $component. See PR #$PR_NUMBER for details."
            else
              local PROMPT
              PROMPT=$(
                cat <<EOF
You are generating release notes for a major semantic version bump.

Component: $component
Tag: $tag
Global Tag: $GLOBAL_TAG

PR #$PR_NUMBER: $PR_TITLE

PR Description:
${PR_BODY:-"(none)"}

Diff/History:
$diff_output

Write concise release notes in Markdown with:
- Summary
- Breaking changes
- Migration notes (if applicable)
- Key changes
EOF
              )

              local RESPONSE
              RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$(jq -n --arg prompt "$PROMPT" '{
                  model: "gpt-4o-mini",
                  temperature: 0.2,
                  messages: [
                    {role: "system", content: "You are a helpful release notes assistant."},
                    {role: "user", content: $prompt}
                  ]
                }')")

              if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
                NOTES="Major release for $component. See PR #$PR_NUMBER for details."
              else
                NOTES=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
              fi
            fi

            if [[ -z "${NOTES:-}" || "$NOTES" == "null" ]]; then
              NOTES="Major release for $component. See PR #$PR_NUMBER for details."
            fi
            NOTES="**Global ver:** $GLOBAL_TAG\n\n${NOTES}"

            gh release create "$tag" \
              --title "$tag" \
              --notes "$NOTES" \
              --repo "$REPO"
          }

          create_release "$FRONT_TAG" "frontend"
          create_release "$BACK_TAG" "backend"
          create_release "$FUNCS_TAG" "functions"
          create_release "$INFRA_TAG" "infra"
