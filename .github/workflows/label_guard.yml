name: Label Guard

on:
  pull_request:
    types: [labeled, unlabeled]

permissions:
  pull-requests: write
  issues: write

jobs:
  enforce_label_rules:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce Label Rules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const number = context.payload.pull_request.number;
            const action = context.payload.action;
            const changedLabel = context.payload.label ? context.payload.label.name : "";
            const actor = context.actor;

            if (action === "labeled" && changedLabel === "approved") {
              if (actor !== "github-actions[bot]") {
                await github.rest.issues.removeLabel({
                  owner, repo, issue_number: number, name: "approved"
                });
                await github.rest.issues.createComment({
                  owner, repo, issue_number: number,
                  body: `â›” **Security Alert:** The 'approved' label cannot be added manually by @${actor}.\n\nPlease use the \`/approve\` command.`
                });
                core.setFailed(`Manual approval attempt blocked for user: ${actor}`);
                return; 
              }
            }

            if (changedLabel !== "approved") {
               const labels = await github.rest.issues.listLabelsOnIssue({
                  owner, repo, issue_number: number
               });
               const labelNames = labels.data.map(l => l.name);

               if (labelNames.includes("approved")) {
                  await github.rest.issues.removeLabel({
                    owner, repo, issue_number: number, name: "approved"
                  });

                  await github.rest.issues.createComment({
                    owner, repo, issue_number: number,
                    body: `ðŸ”„ **System Reset:** Labels were changed by @${actor}. Previous approvals have been invalidated to ensure safety.`
                  });
                  core.info("Approvals reset due to label change.");
               }
            }
